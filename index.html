<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>    
  <!-- Marker cluster styles -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <title>Plannea - Eventos</title>
</head>

<body>
  <!-- HEADER -->
  <header class="main-header">
    <button id="btnUser" class="user-button" aria-label="Login or Profile">üë§</button>
    <img src="images/PLANNEA.png" alt="Plannea Logo" class="logo" />
  <button id="btnSettings" class="settings-button" aria-label="Settings">‚öôÔ∏è</button>
  </header>

  <!-- LOGIN / REGISTER MODAL -->
  <div id="authModal" class="modal" hidden>
    <div class="modal-backdrop" data-close="modal"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <button class="modal-close" data-close="modal" aria-label="Cerrar">‚úï</button>
      <h2 id="authTitle">Cuenta</h2>

      <div class="auth-tabs">
        <button id="tabLogin" class="tab active" aria-pressed="true">Iniciar sesi√≥n</button>
        <button id="tabRegister" class="tab" aria-pressed="false">Registrarse</button>
      </div>

      <div id="authContent">
        <div id="authMessage" class="auth-message" hidden aria-live="polite"></div>

        <div class="auth-forms-row">
          <form id="loginForm" class="auth-form" aria-label="Formulario iniciar sesi√≥n">
          <label for="loginEmail">Correo electr√≥nico
            <input id="loginEmail" name="email" type="email" required />
          </label>
          <label for="loginPassword">Contrase√±a
            <input id="loginPassword" name="password" type="password" required />
          </label>
          <div class="auth-actions">
            <button type="submit" class="primary">Iniciar sesi√≥n</button>
          </div>
          </form>

          <form id="registerForm" class="auth-form" aria-label="Formulario registro">
          <label for="regEmail">Correo electr√≥nico
            <input id="regEmail" name="email" type="email" required />
          </label>
          <label for="regUsername">Nombre de usuario
            <input id="regUsername" name="username" type="text" required />
          </label>
          <label for="regPassword">Contrase√±a
            <input id="regPassword" name="password" type="password" required />
          </label>
          <div class="auth-actions">
            <button type="submit" class="primary">Registrarse</button>
          </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- GEOLOCATION PERMISSION MODAL -->
  <div id="geoModal" class="modal" hidden>
    <div class="modal-backdrop" data-close="geo-modal"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="geoTitle">
      <button class="modal-close" data-close="geo-modal" aria-label="Cerrar">‚úï</button>
      <h2 id="geoTitle">Permiso de ubicaci√≥n necesario</h2>
      <p>Se necesita el acceso a la ubicacion para el buen funcionamiento de la web. Por favor, reinicie la pagina</p>
      <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top: .8rem;">
        <button id="geoReloadBtn" class="primary">Reiniciar p√°gina</button>
      </div>
    </div>
  </div>

  <!-- Toast notifications -->
  <div id="toast" class="toast" hidden aria-live="polite"></div>

  <!-- CONFIRMATION MODAL (reusable) -->
  <div id="confirmModal" class="modal" hidden>
    <div class="modal-backdrop" data-close="confirm-modal"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h2 id="confirmTitle">Confirmar</h2>
      <p id="confirmMessage">¬øEst√°s seguro?</p>
      <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.8rem;">
        <button id="confirmCancel" class="ghost">Cancelar</button>
        <button id="confirmOk" class="primary">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- CONTENIDO -->
  <main>
    <div id="map" style="height: calc(100vh - 120px);"></div>
  </main>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item active" aria-label="Events">
      <!-- Ticket (minimal) -->
      <svg class="nav-icon" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 7h18v4a2 2 0 0 1-2 2 2 2 0 1 0 0 4v4H3v-4a2 2 0 1 0 0-4V7z"/>
      </svg>
      <span class="nav-text">Events</span>
    </a>
    <a href="pages/agenda.html" class="nav-item" aria-label="Agenda">
      <!-- Calendar -->
      <svg class="nav-icon" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="5" width="18" height="16" rx="2"/><path d="M16 3v4M8 3v4M3 11h18"/>
      </svg>
      <span class="nav-text">Agenda</span>
    </a>
    <a href="pages/notificaciones.html" class="nav-item" aria-label="Notifications">
      <!-- Bell -->
      <svg class="nav-icon" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 9h18c0-2-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
      </svg>
      <span class="nav-text">Notifications</span>
    </a>
  </nav>

  <!-- LIBRER√çAS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
  <!-- Shared events data -->
  <script src="js/events.js"></script>

  <!-- MAPA -->
  <script>
    navigator.geolocation.getCurrentPosition(
      function (position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        const map = L.map('map').setView([lat, lng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Map data ¬© OpenStreetMap contributors'
        }).addTo(map);

        // marker cluster group
        const markersGroup = L.markerClusterGroup();

        // marker for user
        const you = L.marker([lat, lng]).bindPopup('Est√°s aqu√≠');
        markersGroup.addLayer(you);

        // Use shared events from js/events.js (window.planneaEvents)
        const baseEvents = window.planneaEvents || [];
        const eventos = baseEvents.map(ev => {
          const off = ev.offset || [0,0];
          return { nombre: ev.nombre, slug: ev.slug, lat: lat + (off[0] || 0), lng: lng + (off[1] || 0) };
        });

        eventos.forEach(e => {
          const m = L.marker([e.lat, e.lng]);
          const safeName = (e.nombre || '').replace(/'/g, "\\'");
          const detailUrl = 'pages/event.html?slug=' + encodeURIComponent(e.slug || '');
          m.bindPopup(`<strong>${e.nombre}</strong><br/><a href="${detailUrl}">Ver detalle</a><br/><button onclick="openPurchaseModal('${safeName}')">Comprar</button>`);
          markersGroup.addLayer(m);
        });

        map.addLayer(markersGroup);
      },
      function () {
        // Mostrar modal de permiso denegado en lugar de alert
        const geoModal = document.getElementById('geoModal');
        if(geoModal){
          geoModal.hidden = false;
          document.body.classList.add('modal-open');
          // close handlers
          const closeBtns = geoModal.querySelectorAll('[data-close="geo-modal"], .modal-close');
          closeBtns.forEach(b => b.addEventListener('click', function(){ geoModal.hidden = true; document.body.classList.remove('modal-open'); }));
          // backdrop click
          geoModal.addEventListener('click', function(e){ if(e.target && e.target.dataset && e.target.dataset.close === 'geo-modal'){ geoModal.hidden = true; document.body.classList.remove('modal-open'); }});
          // reload button
          const reloadBtn = document.getElementById('geoReloadBtn');
          reloadBtn?.addEventListener('click', function(){ location.reload(); });
        }else{
          alert('No se pudo obtener tu ubicaci√≥n. Aseg√∫rate de habilitarla.');
        }
      }
    );
  </script>

  <!-- PURCHASE MODAL -->
  <div id="purchaseModal" class="modal" hidden>
    <div class="modal-backdrop" data-close="purchase-modal"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="purchaseTitle">
      <button class="modal-close" data-close="purchase-modal" aria-label="Cerrar">‚úï</button>
      <h2 id="purchaseTitle">Comprar entrada</h2>
      <div style="display:grid; gap:.6rem;">
        <div><strong id="purchaseEventName"></strong></div>
        <label>Cantidad
          <select id="purchaseQty"><option>1</option><option>2</option><option>3</option><option>4</option></select>
        </label>
        <label>Tu nombre
          <input id="purchaseBuyer" type="text" placeholder="Nombre" />
        </label>
        <div id="purchaseTotal" style="font-weight:700; margin-top:.25rem">Total: -</div>
        <div style="display:flex; gap:.5rem; justify-content:flex-end;">
          <button id="purchaseCancel" class="ghost">Cancelar</button>
          <button id="purchaseConfirm" class="primary">Confirmar compra</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP JS (login/menu perfil) -->
  <script src="js/app.js"></script>
</body>
</html>

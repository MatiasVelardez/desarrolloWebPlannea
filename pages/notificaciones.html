<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plannea - Notificaciones</title>
  <link rel="stylesheet" href="../css/styles.css" />
</head>

<body>
  <header class="main-header">
    <img src="../images/PLANNEA.png" alt="Plannea Logo" class="logo" />
    <button id="btnSettings" class="settings-button" aria-label="Settings">‚öôÔ∏è</button>
  </header>
  <div id="toast" class="toast" hidden aria-live="polite"></div>
  <!-- CONFIRMATION MODAL -->
  <div id="confirmModal" class="modal" hidden>
    <div class="modal-backdrop" data-close="confirm-modal"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h2 id="confirmTitle">Confirmar</h2>
      <p id="confirmMessage">¬øEst√°s seguro?</p>
      <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.8rem;">
        <button id="confirmCancel" class="ghost">Cancelar</button>
        <button id="confirmOk" class="primary">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-button active" onclick="showSection('tickets')">üé´ Mis Tickets</button>
    <button class="tab-button" onclick="showSection('notifications')">üîî Notificaciones</button>
  </div>

  <section id="ticketsSection" class="tab-section active">
    <div class="tickets-header" style="display:flex; gap:.5rem; align-items:center; margin-bottom:.6rem;">
      <input id="ticketsSearch" type="search" placeholder="Buscar mis tickets (evento, comprador, fecha)" aria-label="Buscar mis tickets" style="flex:1; padding:.4rem;" />
    </div>
    <div id="myTicketsContainer">
      <!-- purchases will be rendered here -->
    </div>
  </section>

  <section id="notificationsSection" class="tab-section">
    <div class="notification-card">
      <h3>Nueva entrada disponible</h3>
      <p>La venta de tickets para Indie Fest comenz√≥.</p>
      <span class="notification-date">Hace 2 horas</span>
    </div>
    <div class="notification-card">
      <h3>Evento actualizado</h3>
      <p>Se cambi√≥ la fecha del recital.</p>
      <span class="notification-date">Hace 1 d√≠a</span>
    </div>
    <div class="notification-card">
      <h3>Recordatorio</h3>
      <p>No olvides tu evento ma√±ana a las 19:00.</p>
      <span class="notification-date">Hace 3 d√≠as</span>
    </div>
  </section>

<nav class="bottom-nav">
  <a href="../index.html" class="nav-item active" aria-label="Events">
    <!-- Ticket (minimal) -->
    <svg class="nav-icon" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 7h18v4a2 2 0 0 1-2 2 2 2 0 1 0 0 4v4H3v-4a2 2 0 1 0 0-4V7z"/>
    </svg>
    <span class="nav-text">Events</span>
  </a>
  <a href="../pages/agenda.html" class="nav-item" aria-label="Agenda">
    <!-- Calendar -->
    <svg class="nav-icon" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="5" width="18" height="16" rx="2"/><path d="M16 3v4M8 3v4M3 11h18"/>
    </svg>
    <span class="nav-text">Agenda</span>
  </a>
  <a href="../pages/notificaciones.html" class="nav-item" aria-label="Notifications">
    <!-- Bell -->
    <svg class="nav-icon" viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 9h18c0-2-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
    </svg>
    <span class="nav-text">Notifications</span>
  </a>
</nav>

  <script>
    // render purchases into Mis Tickets
    function renderPurchases(){
      const container = document.getElementById('myTicketsContainer');
      if(!container) return;
      const raw = localStorage.getItem('plannea_purchases');
      const list = raw ? JSON.parse(raw) : [];
      if(!list || list.length === 0){ container.innerHTML = '<div class="notification-card">No hay tickets comprados.</div>'; return; }
      container.innerHTML = '';
      // render newest first
      list.slice().reverse().forEach(function(p){
        const div = document.createElement('div'); div.className = 'notification-card ticket-card';
        // include a cancel button (use purchase date ISO as identifier)
        const dateKey = encodeURIComponent(p.date || '');
        const evt = p.event || '';
        const buyer = p.buyer || '';
        const qty = p.qty || '';
        const when = p.date ? new Date(p.date).toLocaleString() : '';
        div.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:.5rem;"><div style="flex:1"><h3>'+ evt +'</h3><p>Cantidad: '+ qty +' ‚Äî Comprador: '+ buyer +'</p><span class="notification-date">'+ when +'</span></div><div style="margin-left:.5rem"><button class="cancel-ticket ghost" data-date="'+ dateKey +'" aria-label="Cancelar ticket">Cancelar</button></div></div>';
        container.appendChild(div);
      });
    }

    // Delegated click handler for cancel buttons
    document.addEventListener('click', function(e){
      const btn = e.target.closest && e.target.closest('.cancel-ticket');
      if(!btn) return;
      const dateKey = btn.dataset && btn.dataset.date;
      if(!dateKey) return;
      const dateISO = decodeURIComponent(dateKey);
      // find purchase to show a clear message
      const raw = localStorage.getItem('plannea_purchases');
      const list = raw ? JSON.parse(raw) : [];
      const found = list.find(p => p.date === dateISO) || null;
      const title = found ? (found.event || 'este ticket') : 'este ticket';
      const summary = '¬øCancelar la compra para "' + title + '"?\nComprador: ' + (found ? (found.buyer||'') : '') + '\nCantidad: ' + (found ? (found.qty||'') : '') + '\n\nEsto eliminar√° el ticket de "Mis Tickets".';
      // use global showConfirm (falls back to native confirm)
      (window.showConfirm ? window.showConfirm(summary) : Promise.resolve(confirm(summary))).then(function(ok){
        if(!ok) return;
        // remove purchase
        const newList = list.filter(p => p.date !== dateISO);
        localStorage.setItem('plannea_purchases', JSON.stringify(newList));
        // re-render
        renderPurchases();
        // toast
        if(window.showToast) window.showToast('Ticket cancelado'); else alert('Ticket cancelado');
      });
    });

    // search/filter for tickets
    const ticketsSearch = document.getElementById('ticketsSearch');
    if(ticketsSearch){
      ticketsSearch.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase();
        document.querySelectorAll('.ticket-card').forEach(card => {
          const text = (card.textContent || '').toLowerCase();
          card.style.display = q.length === 0 || text.includes(q) ? '' : 'none';
        });
      });
    }

    function showSection(section) {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-section').forEach(sec => sec.classList.remove('active'));
      const btn = document.querySelector('.tab-button[onclick*="'+section+'"]');
      if(btn) btn.classList.add('active');
      const target = document.getElementById(section + 'Section');
      if(target) target.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function(){ renderPurchases(); });
  </script>
  <script src="../js/app.js"></script>
</body>
</html>
